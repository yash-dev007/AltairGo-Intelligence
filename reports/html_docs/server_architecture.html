
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Architecture</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 210mm;
            margin: 40px auto;
            padding: 40px;
            background: #fff;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        h1 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        h2 { color: #2980b9; margin-top: 30px; }
        h3 { color: #16a085; }
        
        /* Tables */
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; color: #333; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        
        /* Code Blocks */
        pre { background: #f4f4f4; padding: 15px; border-radius: 5px; overflow-x: auto; border: 1px solid #ddd; }
        code { font-family: 'Consolas', 'Monaco', monospace; color: #d63384; }
        pre code { color: #333; }
        
        /* Alerts */
        .alert { padding: 15px; border-radius: 4px; margin: 20px 0; border-left: 5px solid; }
        .alert-note { background-color: #e3f2fd; border-color: #2196f3; }
        .alert-tip { background-color: #e8f5e9; border-color: #4caf50; }
        .alert-warning { background-color: #fff3e0; border-color: #ff9800; }
        .alert-important { background-color: #f3e5f5; border-color: #9c27b0; }
        
        /* Mermaid */
        .mermaid { text-align: center; margin: 30px 0; }
        
        /* Print */
        @media print {
            body { box-shadow: none; margin: 0; padding: 0; width: 100%; max-width: 100%; }
            .no-print { display: none; }
        }
    </style>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>
</head>
<body>
<h1>Server Side Architecture (Technical Specification)</h1>
<div class="alert alert-note">
This document is the **Backend Specification** for the **AltairLabs Travel Intelligence Platform**. It includes the exact JSON schemas, algorithm weights, and service internals.

</div>
<h2>1. Core Runtime</h2>
<ul>
<li><strong>Language</strong>: Python 3.12</li>
<li><strong>Web Server</strong>: Flask (WSGI)</li>
<li><strong>Concurrency</strong>: Threaded (<code>app.run(threaded=True, port=5000)</code>)</li>
<li><strong>CORS</strong>: Allow All (<code>*</code>) for easy development using <code>flask_cors</code>.</li>
</ul>
<h2>2. API Specification (OpenAPI Style)</h2>
<h3>A. Destinations</h3>
<p><strong>Endpoint</strong>: <code>GET /destinations</code><br />
<strong>Response Schema</strong>: <code>List[Destination]</code></p>
<pre><code class="language-json">[
  {
    &quot;id&quot;: 101,
    &quot;name&quot;: &quot;Fushimi Inari Taisha&quot;,
    &quot;desc&quot;: &quot;Famous for its thousands of vermilion torii gates...&quot;,
    &quot;price&quot;: &quot;Free&quot;,
    &quot;rating&quot;: 4.8,
    &quot;tag&quot;: &quot;Historic&quot;,
    &quot;location&quot;: &quot;Kyoto&quot;,
    &quot;image&quot;: &quot;https://images.unsplash.com/photo-147839...&quot;,
    &quot;reviews_count_str&quot;: &quot;12k&quot;
  }
]
</div>
<h3>B. Region Population (The AI Agent)</h3>
<p><strong>Endpoint</strong>: <code>POST /regions/:id/populate</code><br />
<strong>Trigger</strong>: Called when a user selects a region with &lt; 5 destinations.</p>
<p><strong>Algorithm (<code>services/ai_destination_service.py</code>):</strong><br />
1.  <strong>Input</strong>: Region Name (e.g., "Kyoto"), Country Name.<br />
2.  <strong>AI Query</strong>: Uses <code>google-genai</code> SDK with models (e.g., <code>gemini-2.0-flash</code>).<br />
    *   <strong>Prompt</strong>: "Generate a list of 50 tourist destinations in {region_name}..."<br />
3.  <strong>Filtering &amp; Enrichment</strong>:<br />
    *   <strong>Images</strong>: Fetches images via Unsplash API using <code>services.image_service</code>.<br />
    *   <strong>Deduplication</strong>: Checks against existing database entries.<br />
4.  <strong>Output</strong>: Returns list of newly created <code>Destination</code> objects.<br />
5.  <strong>Limit</strong>: Max <strong>50 Items</strong> per request.</p>
<h3>C. Smart Destination Generation</h3>
<p><strong>Endpoint</strong>: <code>POST /generate-destinations</code><br />
<strong>Payload</strong>: <code>{ "query": "Paris" }</code></p>
<p><strong>Algorithm (<code>services/generation_service.py</code>):</strong><br />
Uses AI to generate smart suggestions based on the user's free-text query.</p>
<h3>D. Itinerary Generation</h3>
<p><strong>Endpoint</strong>: <code>POST /generate-itinerary</code><br />
<strong>Payload</strong>: <code>{ "selectedDestIds": [...], "preferences": {...} }</code></p>
<p><strong>Algorithm (<code>services/gemini_service.py</code>):</strong><br />
1.  <strong>Context</strong>: Fetches full details of selected destinations from DB.<br />
2.  <strong>AI Generation</strong>: Generates a day-by-day itinerary JSON.<br />
3.  <strong>Image Enrichment</strong>: Adds Unsplash images to the generated itinerary items.</p>
<h2>3. Database Schema (SQLAlchemy)</h2>
<p>The system uses a <strong>Polymorphic Data Model</strong> where <code>Destination</code> is the central node.</p>
<pre><code class="language-python">class Destination(Base):
    __tablename__ = 'destinations'

    id = Column(Integer, primary_key=True)
    name = Column(String(100))

    # Metadata
    crowd_level = Column(String(50)) # &quot;High&quot;, &quot;Low&quot;
    vibe_tags = Column(JSON) # e.g. [&quot;Nature&quot;, &quot;Peaceful&quot;]

    # Relationships
    state_id = Column(Integer, ForeignKey('states.id'))
</div>
<h2>4. Hybrid persistence Strategy</h2>
<div class="alert alert-warning">
We deliberately split **Read-Heavy** and **Write-Heavy** data.

</div>
<ul>
<li><strong>Static Entities (Destinations)</strong>: Stored in <strong>SQLite</strong> (<code>travel.db</code>). Efficient, relational, indexable.</li>
<li><strong>Dynamic Entities (Reviews)</strong>: Stored in <strong>JSON</strong> (<code>reviews.json</code>).<ul>
<li><strong>Reason</strong>: No need for complex relations. Reviews are simple lists appended to a key.</li>
<li><strong>Structure</strong>:<br />
<code>json
    {
      "Destination Name": [
        { "user": "Dave", "rating": 5, "text": "Great!", "date": "2024-01-01" }
      ]
    }</code></li>
</ul>
</li>
</ul>
</body>
</html>
